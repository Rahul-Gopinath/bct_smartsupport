<!DOCTYPE html>
<html lang="en">
<head>
<meta charset="UTF-8">
<title>üéì SmartSupport Log Analyzer üßæ</title>
<style>
  body {
    font-family: Arial, sans-serif;
    background-color: #0f172a;
    color: #f1f5f9;
    margin: 0;
    padding: 40px;
  }

  h1 { text-align: center; margin-bottom: 20px; }

  .center { text-align: center; margin-bottom: 30px; }

  .file-input { display: none; }
  .file-label {
    background-color: #10a37f;
    color: white;
    padding: 10px 18px;
    border-radius: 8px;
    cursor: pointer;
    transition: background 0.3s ease;
    display: inline-block;
  }
  .file-label:hover { background-color: #14b28f; }
  .file-name { margin-left: 12px; color: #cbd5e1; font-size: 0.9rem; }

  .analyze-btn {
    background-color: #2563eb;
    color: white;
    padding: 10px 18px;
    border-radius: 8px;
    border: none;
    cursor: pointer;
    margin-top: 15px;
    transition: background 0.3s ease;
  }
  .analyze-btn:hover { background-color: #1d4ed8; }

  .container { display: flex; gap: 30px; margin-top: 30px; }

  .log-box {
    flex: 2;
    max-height: 70vh;
    overflow: auto;
    padding: 12px;
    background: #111827;
    border: 1px solid rgba(255,255,255,0.1);
    border-radius: 10px;
    white-space: pre;
    font-family: monospace;
    font-size: 0.95rem;
  }

  .suggestion-box {
    flex: 1.5;
    padding: 12px;
    background: #1e293b;
    border-radius: 10px;
    overflow-y: auto;
  }

  .clickable {
    background-color: #dc2626;
    color: white;
    padding: 2px 4px;
    border-radius: 4px;
    cursor: pointer;
    transition: background 0.2s ease, transform 0.1s ease;
    display: inline-block;
  }
  .clickable:hover { background-color: #ef4444; transform: scale(1.02); }
  .clickable.clicked { background-color: #2563eb; }
</style>
</head>

<body>
<h1>üéì SmartSupport Log Analyzer üßæ</h1>

<div id="uploadSection" class="center">
  <input type="file" id="fileInput" class="file-input" multiple accept=".txt,.log,.syslog">
  <label for="fileInput" class="file-label">üìÅ Select Log Files</label>
  <span id="fileName" class="file-name">No files selected</span><br>
  <button id="analyzeBtn" class="analyze-btn">Analyze Files</button>
</div>

<div id="resultsSection" class="container" style="display:none;">
  <div class="log-box" id="logBox"></div>
  <div class="suggestion-box">
    <h3>Suggestions</h3>
    <p id="suggestionText">Click a highlighted line to see suggestions.</p>
  </div>
</div>

<script>
const fileInput = document.getElementById('fileInput');
const fileName = document.getElementById('fileName');
const analyzeBtn = document.getElementById('analyzeBtn');
const uploadSection = document.getElementById('uploadSection');
const resultsSection = document.getElementById('resultsSection');
const logBox = document.getElementById('logBox');
const suggestionBox = document.getElementById('suggestionText');

let currentFileText = "";
let highlightedLines = [];

// Show selected file names
fileInput.addEventListener('change', () => {
  const names = Array.from(fileInput.files).map(f => f.name).join(', ');
  fileName.textContent = names || 'No files selected';
});

// Escape HTML characters
function escapeHtml(text) {
  return text.replace(/&/g, "&amp;")
             .replace(/</g, "&lt;")
             .replace(/>/g, "&gt;");
}

// Display log with highlights and collapse excessive empty lines
function showLogWithHighlights() {
  const lines = currentFileText.split('\n');

  // Collapse consecutive empty lines (max 2)
  const cleanedLines = [];
  let emptyCount = 0;
  for (const line of lines) {
    if (line.trim() === '') {
      emptyCount++;
      if (emptyCount <= 2) cleanedLines.push(line);
    } else {
      emptyCount = 0;
      cleanedLines.push(line);
    }
  }

  let html = '';
  cleanedLines.forEach((line, i) => {
    const safeLine = escapeHtml(line);
    if (highlightedLines.includes(i + 1)) {
      html += `<div class="clickable" data-line="${i + 1}">${safeLine}</div>\n`;
    } else {
      html += `${safeLine}\n`;
    }
  });

  logBox.innerHTML = html;

  document.querySelectorAll('.clickable').forEach(span => {
    span.addEventListener('click', async (e) => {
      document.querySelectorAll('.clickable').forEach(el => el.classList.remove('clicked'));
      e.target.classList.add('clicked');
      const lineText = e.target.textContent;

      const res = await fetch('/suggest', {
        method: 'POST',
        headers: { 'Content-Type': 'application/json' },
        body: JSON.stringify({ lineText })
      });
      console.log({lineText});
      const data = await res.json();
      suggestionBox.textContent = data.suggestion || 'No suggestion found.';
    });
  });
}

// Analyze button click
analyzeBtn.addEventListener('click', async () => {
  if (!fileInput.files.length) {
    alert("Please select log files first.");
    return;
  }

  const formData = new FormData();
  for (const f of fileInput.files) formData.append('files', f);

  const res = await fetch('/detect', { method: 'POST', body: formData });
  const data = await res.json();

  if (data.error) {
    alert(data.error);
    return;
  }

  highlightedLines = data.highlightedLines || [];

  // Display first file's content
  const reader = new FileReader();
  reader.onload = function(e) {
    currentFileText = e.target.result;
    showLogWithHighlights();
  };
  reader.readAsText(fileInput.files[0]);

  uploadSection.style.display = 'none';
  resultsSection.style.display = 'flex';
});
</script>
</body>
</html>
